#!/bin/bash

if [ -e "${HOME}/.config/my-ublue/first-boot-done" ]; then
    echo "Setup already ran!"
    exit 0
fi

echo "# Waiting for internet connection"
until /usr/bin/ping -q -c 1 flathub.org; do sleep 1; done

echo "# Setting up flatpaks"
/usr/bin/flatpak remote-delete flathub --force
/usr/bin/flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
/usr/bin/flatpak install --user --noninteractive org.gnome.Platform//43
/usr/bin/flatpak install --user --noninteractive --reinstall flathub $(flatpak list --app-runtime=org.fedoraproject.Platform --columns=application | tail -n +1 )
/usr/bin/flatpak install --user --noninteractive flathub $(cat /etc/my-ublue/flatpaks)
/usr/bin/flatpak remove --system --noninteractive --all
/usr/bin/flatpak remote-delete fedora --force
/usr/bin/flatpak remote-delete fedora-testing --force

echo "# Running setup"
/usr/bin/bash /etc/my-ublue/setup.sh

mkdir -p "${HOME}/.config/my-ublue"
touch "${HOME}/.config/my-ublue/first-boot-done"

echo "# Completed setup!"
